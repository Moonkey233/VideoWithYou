function d(){const t=Array.from(document.querySelectorAll("video"));let e=null,a=0;for(const n of t){const i=n.getBoundingClientRect(),u=i.width*i.height;u<=0||f(i)&&u>a&&(e=n,a=u)}return e}function f(t){return t.width>0&&t.height>0}function p(t="generic"){return{name:t,detect(){return 1},attach(){return d()},readState(e){return{position_ms:Math.floor(e.currentTime*1e3),duration_ms:Number.isFinite(e.duration)?Math.floor(e.duration*1e3):0,paused:e.paused,rate:e.playbackRate||1,media:{url:location.href,title:document.title,site:t,attrs:{video_src:e.currentSrc||""}}}},async applyState(e,a){if(a.rate&&Math.abs(e.playbackRate-a.rate)>.001&&(e.playbackRate=a.rate),a.position_ms>=0){const n=a.position_ms/1e3;Math.abs(e.currentTime-n)>.05&&(e.currentTime=n)}if(a.paused)e.paused||e.pause();else if(e.paused)try{await e.play()}catch{}},observe(e,a){const n=()=>a();e.addEventListener("timeupdate",n),e.addEventListener("play",n),e.addEventListener("pause",n),e.addEventListener("ratechange",n),e.addEventListener("seeking",n)}}}function h(t){const e=t.match(/BV[0-9A-Za-z]+/);return e?e[0]:""}function y(){const t=p("bilibili");return{...t,detect(){return location.hostname.includes("bilibili.com")?10:0},readState(e){const a=t.readState(e);a.media.attrs=a.media.attrs||{};const n=h(location.href);return n&&(a.media.attrs.bv=n),a.media.site="bilibili",a}}}function m(){return{...p("quark"),detect(){return location.hostname.includes("quark")?9:0}}}const o=[y(),m(),p("generic")],b=3e3;let s=o[o.length-1],r=null;function g(){let t=o[o.length-1],e=-1;for(const a of o){const n=a.detect();n>e&&(e=n,t=a)}return t}function c(){s=g(),r=s.attach(),r&&(s.observe(r,l),l()),S()}function S(){chrome.runtime.sendMessage({type:"ext_hello",payload:{url:location.href,site:s.name,version:"v2"}})}function l(){if(!r)return;const t=s.readState(r);chrome.runtime.sendMessage({type:"player_state",payload:t})}async function _(t){r||c(),r&&await s.applyState(r,t)}function M(t){var e,a;if(!(!t||!t.type)){if(t.type==="apply_state"){_(t.payload);return}if(t.type==="navigate"){const n=(e=t.payload)==null?void 0:e.url;typeof n=="string"&&n.length>0&&n!==location.href&&(location.href=n);return}if(t.type==="notify"){const n=(a=t.payload)==null?void 0:a.message;typeof n=="string"&&n.trim()&&window.alert(n)}}}function w(){const t=()=>setTimeout(c,200),e=history.pushState,a=history.replaceState;history.pushState=function(...i){e.apply(history,i),t()},history.replaceState=function(...i){a.apply(history,i),t()},window.addEventListener("popstate",t),new MutationObserver(()=>{(!r||r.isConnected===!1)&&c()}).observe(document.documentElement,{childList:!0,subtree:!0})}chrome.runtime.onMessage.addListener(M);c();w();setInterval(l,1e3);setInterval(()=>{chrome.runtime.sendMessage({type:"ext_ping"})},b);
