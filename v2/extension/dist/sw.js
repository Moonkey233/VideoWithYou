const q="127.0.0.1";const $="/ext";let n=null,y=null,u=null,i=null,D=0;const p=[];let m=27111,T=!1,h=!1,v=!1,_=!1,A=null,b="",C=0,s="",l=null;const j=1500,M=new Map;function d(e){e||(_=!1,A=null,b="",C=0),chrome.runtime.sendMessage({type:"client_status",payload:{connected:e}})}function E(e){const t=Date.now();return e&&e===b&&t-C<5e3?!1:(b=e,C=t,!0)}function F(e){e&&x({type:"notify",payload:{message:e}})}function H(e){const t=e.toLowerCase();return t.includes("room closed")||t.includes("host left")}function N(e){return e?e.startsWith("http://")||e.startsWith("https://")||e.startsWith("file://"):!1}function S(e,t){if(!N(t))return;const o=Date.now(),r=M.get(e)??0;o-r<j||(M.set(e,o),chrome.tabs.sendMessage(e,{type:"ext_probe"},()=>{chrome.runtime.lastError&&chrome.scripting.executeScript({target:{tabId:e},files:["content.js"]},()=>{})}))}function I(e){l=e,typeof e=="number"&&(y=e)}function w(e){if(!e||typeof e.id!="number"){I(null);return}if(!N(e.url)){I(null);return}I(e.id),S(e.id,e.url)}function L(){chrome.tabs.query({active:!0,lastFocusedWindow:!0},e=>{const t=e[0];t!=null&&t.id&&(u=t.id,typeof t.windowId=="number"&&(i=t.windowId)),w(t),t!=null&&t.id&&S(t.id,t.url)})}function J(e){const t=e.tab;return!t||typeof t.id!="number"?!1:s==="follower"?l===null?N(t.url)?(w(t),!0):!1:t.id===l:V(e)}function z(e){const t=typeof(e==null?void 0:e.role)=="string"?e.role:"",o=t==="host"||t==="follower",r=typeof(e==null?void 0:e.server_connected)=="boolean"?e.server_connected:null,c=typeof(e==null?void 0:e.last_error)=="string"?e.last_error.trim():"",f=c?H(c):!1;!_&&o&&(b="",C=0),_&&!o&&c?f&&E("room_closed")?F("房主已退出, 房间已解散"):!f&&E(`room_error:${c}`)&&F(`房间已结束: ${c}`):o&&A===!0&&r===!1&&E("server_disconnected")&&F("服务器连接中断, 请检查网络"),t!=="follower"?l=null:l===null&&L(),s=t,_=o,A=r}function U(e){const t=Number.parseInt(String(e),10);return!Number.isFinite(t)||t<1||t>65535?null:t}function B(){return`ws://${q}:${m}${$}`}function R(){T||h||(h=!0,chrome.storage.local.get({client_port:27111},e=>{m=U(e.client_port)??27111,T=!0,h=!1,v&&(v=!1,W())}))}function G(e){const t=U(e);if(!(t===null||t===m)){if(m=t,T=!0,h=!1,chrome.storage.local.set({client_port:t}),n)try{n.close()}catch{}n=null,d(!1),W()}}function W(){if(!T){v=!0,R();return}const e=Date.now();if(!(n&&(n.readyState===WebSocket.OPEN||n.readyState===WebSocket.CONNECTING))&&!(e-D<1500)){D=e;try{n=new WebSocket(B())}catch(t){console.warn("local client ws connect failed",t),n=null,d(!1);return}n.onopen=()=>{for(d(!0);p.length>0&&n&&n.readyState===WebSocket.OPEN;){const t=p.shift();t&&n.send(t)}g({type:"ui_action",payload:{action:"refresh_state"}})},n.onmessage=t=>{try{const o=JSON.parse(t.data);Q(o)}catch{}},n.onclose=()=>{n=null,d(!1)},n.onerror=()=>{d(!1)}}}function K(e){p.push(e),p.length>50&&p.shift()}function g(e){if(!e||!e.type)return;const t=JSON.stringify(e);if(!n||n.readyState!==WebSocket.OPEN){e.type!=="player_state"&&e.type!=="ext_hello"&&e.type!=="ext_ping"&&K(t),W();return}n.send(t)}function Q(e){if(!(!e||!e.type)){if(e.type==="apply_state"||e.type==="navigate"){x(e);return}if(e.type==="ui_state"){z(e.payload),chrome.runtime.sendMessage(e);return}e.type==="room_event"&&chrome.runtime.sendMessage(e)}}function x(e){var r;const t=s==="follower"?l:u,o=((r=e.payload)==null?void 0:r.tabId)??t??y;if(typeof o=="number"){chrome.tabs.sendMessage(o,e);return}chrome.tabs.query({active:!0,lastFocusedWindow:!0},c=>{var f;(f=c[0])!=null&&f.id&&chrome.tabs.sendMessage(c[0].id,e)})}function k(e){const t={active:!0};typeof e=="number"?t.windowId=e:t.lastFocusedWindow=!0,chrome.tabs.query(t,o=>{const r=o[0];r!=null&&r.id&&(u=r.id,typeof r.windowId=="number"&&(i=r.windowId),s==="follower"&&l===null&&w(r))})}function V(e){const t=e.tab;return!t||typeof t.id!="number"?!1:t.active?(u=t.id,typeof t.windowId=="number"&&(i=t.windowId),!0):i!==null&&typeof t.windowId=="number"&&t.windowId!==i?!1:u!==null&&t.id===u}chrome.runtime.onMessage.addListener((e,t)=>{var r,c,f,O;if(!e||!e.type)return;if(e.type==="set_client_port"){G((r=e.payload)==null?void 0:r.port);return}if(e.type==="ui_action"){const a=(c=e.payload)==null?void 0:c.action;a==="join_room"?L():(a==="leave_room"||a==="create_room")&&(l=null)}if(!!((f=t.tab)!=null&&f.id)){const a=e.type==="player_state"||e.type==="ext_hello"||e.type==="ext_ping",P=J(t);if(a&&!P)return;a&&((O=t.tab)!=null&&O.id)&&P&&(y=t.tab.id)}g(e)});chrome.tabs.onActivated.addListener(e=>{u=e.tabId,i=e.windowId,s==="follower"&&l===null?chrome.tabs.get(e.tabId,t=>{w(t)}):chrome.tabs.get(e.tabId,t=>{t!=null&&t.id&&S(t.id,t.url)})});chrome.tabs.onRemoved.addListener(e=>{e===u&&(u=null),e===y&&(y=null),e===l&&(l=null,s==="follower"&&L())});chrome.tabs.onUpdated.addListener((e,t,o)=>{if(o.active&&(i===null||o.windowId===i)&&(u=e,typeof o.windowId=="number"&&(i=o.windowId),S(e,t.url??o.url)),e===l){const r=t.url??o.url;N(r)||(l=null,s==="follower"&&L())}else s==="follower"&&l===null&&o.active&&w(o)});chrome.windows.onFocusChanged.addListener(e=>{if(e===chrome.windows.WINDOW_ID_NONE){i=null;return}i=e,k(e)});chrome.windows.getLastFocused(e=>{e!=null&&e.id&&(i=e.id),k(e==null?void 0:e.id)});R();
