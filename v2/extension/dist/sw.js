const M="127.0.0.1";const k="/ext";let o=null,y=null,l=null,i=null,O=0;const p=[];let h=27111,T=!1,_=!1,v=!1,b=!1,L=null,m="",I=0,s="",f=null;function d(e){e||(b=!1,L=null,m="",I=0),chrome.runtime.sendMessage({type:"client_status",payload:{connected:e}})}function N(e){const t=Date.now();return e&&e===m&&t-I<5e3?!1:(m=e,I=t,!0)}function C(e){e&&R({type:"notify",payload:{message:e}})}function q(e){const t=e.toLowerCase();return t.includes("room closed")||t.includes("host left")}function w(e){f=e,typeof e=="number"&&(y=e)}function S(){if(typeof l=="number"){w(l);return}chrome.tabs.query({active:!0,lastFocusedWindow:!0},e=>{const t=e[0];t!=null&&t.id&&(l=t.id,typeof t.windowId=="number"&&(i=t.windowId),w(t.id))})}function x(e){const t=e.tab;return!t||typeof t.id!="number"?!1:s==="follower"?f===null?P(e)?(w(t.id),!0):!1:t.id===f:P(e)}function $(e){const t=typeof(e==null?void 0:e.role)=="string"?e.role:"",n=t==="host"||t==="follower",r=typeof(e==null?void 0:e.server_connected)=="boolean"?e.server_connected:null,c=typeof(e==null?void 0:e.last_error)=="string"?e.last_error.trim():"",u=c?q(c):!1;!b&&n&&(m="",I=0),b&&!n&&c?u&&N("room_closed")?C("房主已退出, 房间已解散"):!u&&N(`room_error:${c}`)&&C(`房间已结束: ${c}`):n&&L===!0&&r===!1&&N("server_disconnected")&&C("服务器连接中断, 请检查网络"),t!=="follower"?f=null:f===null&&S(),s=t,b=n,L=r}function W(e){const t=Number.parseInt(String(e),10);return!Number.isFinite(t)||t<1||t>65535?null:t}function g(){return`ws://${M}:${h}${k}`}function D(){T||_||(_=!0,chrome.storage.local.get({client_port:27111},e=>{h=W(e.client_port)??27111,T=!0,_=!1,v&&(v=!1,E())}))}function H(e){const t=W(e);if(!(t===null||t===h)){if(h=t,T=!0,_=!1,chrome.storage.local.set({client_port:t}),o)try{o.close()}catch{}o=null,d(!1),E()}}function E(){if(!T){v=!0,D();return}const e=Date.now();if(!(o&&(o.readyState===WebSocket.OPEN||o.readyState===WebSocket.CONNECTING))&&!(e-O<1500)){O=e;try{o=new WebSocket(g())}catch(t){console.warn("local client ws connect failed",t),o=null,d(!1);return}o.onopen=()=>{for(d(!0);p.length>0&&o&&o.readyState===WebSocket.OPEN;){const t=p.shift();t&&o.send(t)}},o.onmessage=t=>{try{const n=JSON.parse(t.data);z(n)}catch{}},o.onclose=()=>{o=null,d(!1)},o.onerror=()=>{d(!1)}}}function J(e){p.push(e),p.length>50&&p.shift()}function j(e){if(!e||!e.type)return;const t=JSON.stringify(e);if(!o||o.readyState!==WebSocket.OPEN){e.type!=="player_state"&&e.type!=="ext_hello"&&e.type!=="ext_ping"&&J(t),E();return}o.send(t)}function z(e){if(!(!e||!e.type)){if(e.type==="apply_state"||e.type==="navigate"){R(e);return}if(e.type==="ui_state"){$(e.payload),chrome.runtime.sendMessage(e);return}e.type==="room_event"&&chrome.runtime.sendMessage(e)}}function R(e){var r;const t=s==="follower"?f:l,n=((r=e.payload)==null?void 0:r.tabId)??t??y;if(typeof n=="number"){chrome.tabs.sendMessage(n,e);return}chrome.tabs.query({active:!0,lastFocusedWindow:!0},c=>{var u;(u=c[0])!=null&&u.id&&chrome.tabs.sendMessage(c[0].id,e)})}function U(e){const t={active:!0};typeof e=="number"?t.windowId=e:t.lastFocusedWindow=!0,chrome.tabs.query(t,n=>{const r=n[0];r!=null&&r.id&&(l=r.id,typeof r.windowId=="number"&&(i=r.windowId),s==="follower"&&f===null&&w(r.id))})}function P(e){const t=e.tab;return!t||typeof t.id!="number"||i!==null&&typeof t.windowId=="number"&&t.windowId!==i?!1:t.active?(l=t.id,typeof t.windowId=="number"&&(i=t.windowId),!0):l!==null&&t.id===l}chrome.runtime.onMessage.addListener((e,t)=>{var r,c,u,F;if(!e||!e.type)return;if(e.type==="set_client_port"){H((r=e.payload)==null?void 0:r.port);return}if(e.type==="ui_action"){const a=(c=e.payload)==null?void 0:c.action;a==="join_room"?S():(a==="leave_room"||a==="create_room")&&(f=null)}if(!!((u=t.tab)!=null&&u.id)){const a=e.type==="player_state"||e.type==="ext_hello"||e.type==="ext_ping",A=x(t);if(a&&!A)return;a&&((F=t.tab)!=null&&F.id)&&A&&(y=t.tab.id)}j(e)});chrome.tabs.onActivated.addListener(e=>{l=e.tabId,i=e.windowId,s==="follower"&&f===null&&w(e.tabId)});chrome.tabs.onRemoved.addListener(e=>{e===l&&(l=null),e===y&&(y=null),e===f&&(f=null,s==="follower"&&S())});chrome.tabs.onUpdated.addListener((e,t,n)=>{n.active&&(i===null||n.windowId===i)&&(l=e,typeof n.windowId=="number"&&(i=n.windowId))});chrome.windows.onFocusChanged.addListener(e=>{if(e===chrome.windows.WINDOW_ID_NONE){i=null;return}i=e,U(e)});chrome.windows.getLastFocused(e=>{e!=null&&e.id&&(i=e.id),U(e==null?void 0:e.id)});D();
