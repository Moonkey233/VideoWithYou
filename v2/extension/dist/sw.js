const F="127.0.0.1";const P="/ext";let o=null,p=null,c=null,l=null,L=0;const f=[];let y=27111,h=!1,u=!1,I=!1,d=!1,m=null,_="",w=0;function s(e){e||(d=!1,m=null,_="",w=0),chrome.runtime.sendMessage({type:"client_status",payload:{connected:e}})}function b(e){const t=Date.now();return e&&e===_&&t-w<5e3?!1:(_=e,w=t,!0)}function T(e){e&&S({type:"notify",payload:{message:e}})}function W(e){const t=e.toLowerCase();return t.includes("room closed")||t.includes("host left")}function D(e){return e.toLowerCase().includes("extension idle")}function R(e){const t=typeof(e==null?void 0:e.role)=="string"?e.role:"",n=t==="host"||t==="follower",r=typeof(e==null?void 0:e.server_connected)=="boolean"?e.server_connected:null,i=typeof(e==null?void 0:e.last_error)=="string"?e.last_error.trim():"",a=i?W(i):!1;!d&&n&&(_="",w=0),d&&!n&&i?D(i)||(a&&b("room_closed")?T("房主已退出, 房间已解散"):!a&&b(`room_error:${i}`)&&T(`房间已结束: ${i}`)):n&&m===!0&&r===!1&&b("server_disconnected")&&T("服务器连接中断, 请检查网络"),d=n,m=r}function E(e){const t=Number.parseInt(String(e),10);return!Number.isFinite(t)||t<1||t>65535?null:t}function U(){return`ws://${F}:${y}${P}`}function v(){h||u||(u=!0,chrome.storage.local.get({client_port:27111},e=>{y=E(e.client_port)??27111,h=!0,u=!1,I&&(I=!1,N())}))}function M(e){const t=E(e);if(!(t===null||t===y)){if(y=t,h=!0,u=!1,chrome.storage.local.set({client_port:t}),o)try{o.close()}catch{}o=null,s(!1),N()}}function N(){if(!h){I=!0,v();return}const e=Date.now();if(!(o&&(o.readyState===WebSocket.OPEN||o.readyState===WebSocket.CONNECTING))&&!(e-L<1500)){L=e;try{o=new WebSocket(U())}catch(t){console.warn("local client ws connect failed",t),o=null,s(!1);return}o.onopen=()=>{for(s(!0);f.length>0&&o&&o.readyState===WebSocket.OPEN;){const t=f.shift();t&&o.send(t)}},o.onmessage=t=>{try{const n=JSON.parse(t.data);k(n)}catch{}},o.onclose=()=>{o=null,s(!1)},o.onerror=()=>{s(!1)}}}function g(e){f.push(e),f.length>50&&f.shift()}function x(e){if(!e||!e.type)return;const t=JSON.stringify(e);if(!o||o.readyState!==WebSocket.OPEN){e.type!=="player_state"&&e.type!=="ext_hello"&&e.type!=="ext_ping"&&g(t),N();return}o.send(t)}function k(e){if(!(!e||!e.type)){if(e.type==="apply_state"||e.type==="navigate"){S(e);return}if(e.type==="ui_state"){R(e.payload),chrome.runtime.sendMessage(e);return}e.type==="room_event"&&chrome.runtime.sendMessage(e)}}function S(e){var n;const t=((n=e.payload)==null?void 0:n.tabId)??c??p;if(typeof t=="number"){chrome.tabs.sendMessage(t,e);return}chrome.tabs.query({active:!0,lastFocusedWindow:!0},r=>{var i;(i=r[0])!=null&&i.id&&chrome.tabs.sendMessage(r[0].id,e)})}function A(e){const t={active:!0};typeof e=="number"?t.windowId=e:t.lastFocusedWindow=!0,chrome.tabs.query(t,n=>{const r=n[0];r!=null&&r.id&&(c=r.id,typeof r.windowId=="number"&&(l=r.windowId))})}function $(e){const t=e.tab;return!t||typeof t.id!="number"||l!==null&&typeof t.windowId=="number"&&t.windowId!==l?!1:t.active?(c=t.id,typeof t.windowId=="number"&&(l=t.windowId),!0):c!==null&&t.id===c}chrome.runtime.onMessage.addListener((e,t)=>{var r,i,a;if(!e||!e.type)return;if(e.type==="set_client_port"){M((r=e.payload)==null?void 0:r.port);return}if(!!((i=t.tab)!=null&&i.id)){const O=e.type==="player_state"||e.type==="ext_hello",C=$(t);if(O&&!C)return;C&&((a=t.tab)!=null&&a.id)&&(p=t.tab.id)}x(e)});chrome.tabs.onActivated.addListener(e=>{c=e.tabId,l=e.windowId});chrome.tabs.onRemoved.addListener(e=>{e===c&&(c=null),e===p&&(p=null)});chrome.tabs.onUpdated.addListener((e,t,n)=>{n.active&&(l===null||n.windowId===l)&&(c=e,typeof n.windowId=="number"&&(l=n.windowId))});chrome.windows.onFocusChanged.addListener(e=>{if(e===chrome.windows.WINDOW_ID_NONE){l=null;return}l=e,A(e)});chrome.windows.getLastFocused(e=>{e!=null&&e.id&&(l=e.id),A(e==null?void 0:e.id)});v();
