const B="127.0.0.1";const J="/ext";let n=null,T=null,c=null,l=null,U=0;const _=[];let S=23333,v=!1,E=!1,O=!1,N=!1,P=null,F="",I=0,f="",R="browser",i=null;const z=1500,x=new Map;function s(){return R==="browser"}function g(){return f==="follower"&&s()}function m(e){e||(N=!1,P=null,F="",I=0),chrome.runtime.sendMessage({type:"client_status",payload:{connected:e}})}function L(e){const t=Date.now();return e&&e===F&&t-I<5e3?!1:(F=e,I=t,!0)}function A(e){e&&H({type:"notify",payload:{message:e}})}function G(e){const t=e.toLowerCase();return t.includes("room closed")||t.includes("host left")}function b(e){return e?e.startsWith("http://")||e.startsWith("https://")||e.startsWith("file://"):!1}function p(e,t){if(!b(t))return;const o=Date.now(),r=x.get(e)??0;o-r<z||(x.set(e,o),chrome.tabs.sendMessage(e,{type:"ext_probe"},()=>{chrome.runtime.lastError&&chrome.scripting.executeScript({target:{tabId:e},files:["content.js"]},()=>{})}))}function W(e){i=e,typeof e=="number"&&(T=e)}function C(e){if(!e||typeof e.id!="number"){W(null);return}if(!b(e.url)){W(null);return}g()&&(W(e.id),p(e.id,e.url))}function y(){g()&&chrome.tabs.query({active:!0,lastFocusedWindow:!0},e=>{const t=e[0];t!=null&&t.id&&(c=t.id,typeof t.windowId=="number"&&(l=t.windowId)),C(t),t!=null&&t.id&&p(t.id,t.url)})}function K(){if(g()){if(typeof i=="number"){chrome.tabs.get(i,e=>{if(chrome.runtime.lastError||!e||!b(e.url)){i=null,y();return}p(e.id,e.url)});return}y()}}function Q(){f!=="host"||!s()||chrome.tabs.query({active:!0,lastFocusedWindow:!0},e=>{const t=e[0];t!=null&&t.id&&(c=t.id,typeof t.windowId=="number"&&(l=t.windowId),p(t.id,t.url))})}function V(e){const t=e.tab;return!t||typeof t.id!="number"||!s()?!1:f==="follower"?i===null?b(t.url)?(C(t),!0):!1:t.id===i:oe(e)}function X(e){const t=typeof(e==null?void 0:e.role)=="string"?e.role:"",o=typeof(e==null?void 0:e.endpoint)=="string"?e.endpoint:"",r=f,a=R,d=t==="host"||t==="follower",w=typeof(e==null?void 0:e.server_connected)=="boolean"?e.server_connected:null,u=typeof(e==null?void 0:e.last_error)=="string"?e.last_error.trim():"",h=u?G(u):!1,M=o!==""&&o!==a;!N&&d&&(F="",I=0),N&&!d&&u?h&&L("room_closed")?A("房主已退出, 房间已解散"):!h&&L(`room_error:${u}`)&&A(`房间已结束: ${u}`):d&&P===!0&&w===!1&&L("server_disconnected")&&A("服务器连接中断, 请检查网络"),o!==""&&(R=o),f=t,t!=="follower"?i=null:s()&&(M?K():i===null&&y()),(M||r!==t)&&t==="host"&&s()&&Q(),N=d,P=w}function k(e){const t=Number.parseInt(String(e),10);return!Number.isFinite(t)||t<1||t>65535?null:t}function Y(){return`ws://${B}:${S}${J}`}function q(){v||E||(E=!0,chrome.storage.local.get({client_port:23333},e=>{S=k(e.client_port)??23333,v=!0,E=!1,O&&(O=!1,D())}))}function Z(e){const t=k(e);if(!(t===null||t===S)){if(S=t,v=!0,E=!1,chrome.storage.local.set({client_port:t}),n)try{n.close()}catch{}n=null,m(!1),D()}}function D(){if(!v){O=!0,q();return}const e=Date.now();if(!(n&&(n.readyState===WebSocket.OPEN||n.readyState===WebSocket.CONNECTING))&&!(e-U<1500)){U=e;try{n=new WebSocket(Y())}catch(t){console.warn("local client ws connect failed",t),n=null,m(!1);return}n.onopen=()=>{for(m(!0);_.length>0&&n&&n.readyState===WebSocket.OPEN;){const t=_.shift();t&&n.send(t)}$({type:"ui_action",payload:{action:"refresh_state"}})},n.onmessage=t=>{try{const o=JSON.parse(t.data);te(o)}catch{}},n.onclose=()=>{n=null,m(!1)},n.onerror=()=>{m(!1)}}}function ee(e){_.push(e),_.length>50&&_.shift()}function $(e){if(!e||!e.type)return;const t=JSON.stringify(e);if(!n||n.readyState!==WebSocket.OPEN){e.type!=="player_state"&&e.type!=="ext_hello"&&e.type!=="ext_ping"&&ee(t),D();return}n.send(t)}function te(e){if(!(!e||!e.type)){if(e.type==="apply_state"||e.type==="navigate"){H(e);return}if(e.type==="ui_state"){X(e.payload),chrome.runtime.sendMessage(e);return}e.type==="room_event"&&chrome.runtime.sendMessage(e)}}function H(e){var r;const t=f==="follower"?i:c,o=((r=e.payload)==null?void 0:r.tabId)??t??T;if(typeof o=="number"){chrome.tabs.sendMessage(o,e);return}chrome.tabs.query({active:!0,lastFocusedWindow:!0},a=>{var d;(d=a[0])!=null&&d.id&&chrome.tabs.sendMessage(a[0].id,e)})}function j(e){const t={active:!0};typeof e=="number"?t.windowId=e:t.lastFocusedWindow=!0,chrome.tabs.query(t,o=>{const r=o[0];r!=null&&r.id&&(c=r.id,typeof r.windowId=="number"&&(l=r.windowId),f==="host"&&s()&&p(r.id,r.url),f==="follower"&&i===null&&C(r))})}function oe(e){const t=e.tab;return!t||typeof t.id!="number"?!1:t.active?(c=t.id,typeof t.windowId=="number"&&(l=t.windowId),!0):l!==null&&typeof t.windowId=="number"&&t.windowId!==l?!1:c!==null&&t.id===c}chrome.runtime.onMessage.addListener((e,t)=>{var r,a,d,w;if(!e||!e.type)return;if(e.type==="set_client_port"){Z((r=e.payload)==null?void 0:r.port);return}if(e.type==="ui_action"){const u=(a=e.payload)==null?void 0:a.action;u==="join_room"?s()&&y():(u==="leave_room"||u==="create_room")&&(i=null)}if(!!((d=t.tab)!=null&&d.id)){const u=e.type==="player_state"||e.type==="ext_hello"||e.type==="ext_ping",h=V(t);if(u&&!h)return;u&&((w=t.tab)!=null&&w.id)&&h&&(T=t.tab.id)}$(e)});chrome.tabs.onActivated.addListener(e=>{c=e.tabId,l=e.windowId,f==="follower"&&i===null&&s()?chrome.tabs.get(e.tabId,t=>{C(t)}):chrome.tabs.get(e.tabId,t=>{t!=null&&t.id&&p(t.id,t.url)})});chrome.tabs.onRemoved.addListener(e=>{e===c&&(c=null),e===T&&(T=null),e===i&&(i=null,f==="follower"&&s()&&y())});chrome.tabs.onUpdated.addListener((e,t,o)=>{if(o.active&&(l===null||o.windowId===l)&&(c=e,typeof o.windowId=="number"&&(l=o.windowId),p(e,t.url??o.url)),e===i){const r=t.url??o.url;b(r)||(i=null,f==="follower"&&s()&&y())}else f==="follower"&&i===null&&o.active&&s()&&C(o)});chrome.windows.onFocusChanged.addListener(e=>{if(e===chrome.windows.WINDOW_ID_NONE){l=null;return}l=e,j(e)});chrome.windows.getLastFocused(e=>{e!=null&&e.id&&(l=e.id),j(e==null?void 0:e.id)});q();
