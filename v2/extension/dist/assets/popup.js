(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))l(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&l(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function l(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const m=document.getElementById("status"),B=document.getElementById("roomLabelPrefix"),x=document.getElementById("roomCode"),q=document.getElementById("membersCount"),D=document.getElementById("error"),$=document.getElementById("roomEvents"),_=document.getElementById("lastSync"),H=document.getElementById("roleBadge"),K=document.getElementById("endpointBadge"),W=document.getElementById("joinCode"),y=document.getElementById("displayName"),b=document.getElementById("preRoom"),w=document.getElementById("inRoom"),i=document.getElementById("copyBtn"),L=document.getElementById("followUrl"),k=document.getElementById("clientPort"),z=document.getElementById("applyPortBtn"),E=document.getElementById("createBtn"),g=document.getElementById("joinBtn"),G=document.getElementById("leaveBtn");let f=!1,h=null,I="",s;const P=i.textContent||"复制房间号",v=27111;let p=v;const c=[],S=6,J=["进入了房间","离开了房间"];function N(){if(!f){m.textContent="本地客户端未连接";return}if(h===!0){m.textContent="本地客户端已连接, 服务器已连接";return}if(h===!1){m.textContent="本地客户端已连接, 服务器未连接";return}m.textContent="本地客户端已连接"}function Q(e){switch(e){case"host":return"房主";case"follower":return"成员";default:return"-"}}function V(e){switch(e){case"browser":return"在线浏览器";case"potplayer":return"本地播放器";default:return"-"}}function X(e){if(typeof e!="string")return"";const t=e.trim();if(!t)return"";const n=t.toLowerCase();return n==="already in a room"?"已经在房间中":n==="room action pending"?"房间操作处理中":n==="nickname required"?"请先填写昵称":n==="room not found"?"房间不存在":n==="room closed (host left)"?"房间已解散 (房主离开)":n==="extension idle, left room"?"扩展空闲, 已退出房间":n.includes("room closed")?"房间已解散":t}function d(e,t={}){chrome.runtime.sendMessage({type:"ui_action",payload:{action:e,...t}})}function O(){$.innerHTML="";for(const e of c){const t=document.createElement("div"),n=Y(e);if(n&&n.name){const l=document.createElement("span");l.className="event-name",l.textContent=n.name;const o=document.createElement("span");o.className="event-action",o.textContent=` ${n.action}`,t.append(l,o)}else t.textContent=e;$.appendChild(t)}}function Y(e){const t=e.trim();if(!t)return null;for(const n of J)if(t.endsWith(n))return{name:t.slice(0,t.length-n.length).trim(),action:n};return null}function Z(e){e&&(c.push(e),c.length>S&&c.shift(),O())}function F(){c.length=0,O()}function ee(e){if(Array.isArray(e)){c.length=0;for(const t of e)typeof t=="string"&&c.push(t);c.length>S&&c.splice(0,c.length-S),O()}}function U(e){const t=Number.parseInt(e,10);return!Number.isFinite(t)||t<1||t>65535?null:t}function R(e){p=e,k.value=String(e)}E.addEventListener("click",()=>{const e=y.value.trim();d("create_room",{display_name:e})});g.addEventListener("click",()=>{const e=W.value.trim(),t=y.value.trim();e&&d("join_room",{room_code:e,display_name:t})});G.addEventListener("click",()=>d("leave_room"));i.addEventListener("click",()=>{I&&(navigator.clipboard.writeText(I).catch(()=>{}),i.textContent="已复制",i.classList.add("copied"),i.disabled=!0,s&&window.clearTimeout(s),s=window.setTimeout(()=>{i.textContent=P,i.classList.remove("copied"),i.disabled=!1},3e3))});for(const e of document.querySelectorAll("input[name='endpoint']"))e.addEventListener("change",()=>{e.checked&&d("set_endpoint",{endpoint:e.value})});L.addEventListener("change",()=>{d("set_follow_url",{follow_url:L.checked})});z.addEventListener("click",()=>{const e=U(k.value.trim());if(e===null){R(p);return}e!==p&&(p=e,chrome.runtime.sendMessage({type:"set_client_port",payload:{port:e}}))});k.addEventListener("keydown",e=>{e.key==="Enter"&&z.click()});chrome.runtime.onMessage.addListener(e=>{var A,M;if(!e||!e.type)return;if(e.type==="client_status"){f=!!((A=e.payload)!=null&&A.connected),f||(h=null,b.hidden=!1,w.hidden=!0,E.disabled=!1,g.disabled=!1,s&&(window.clearTimeout(s),s=void 0),i.textContent=P,i.classList.remove("copied"),i.disabled=!1,F(),_.textContent="-",B.textContent="房间号: ",x.textContent="-",q.textContent="-"),N();return}if(e.type==="room_event"){Z(String(((M=e.payload)==null?void 0:M.message)||""));return}if(e.type!=="ui_state")return;const t=e.payload||{};f=!0,h=typeof t.server_connected=="boolean"?t.server_connected:null,N();const n=t.room_code||"";I=n;const l=t.display_name||"",o=t.host_display_name||"";!y.value&&l&&(y.value=l);const r=o||l;if(n){const C=r?`${r}的房间号: `:"房间号: ";B.textContent=C,x.textContent=n}else B.textContent="房间号: ",x.textContent="-";const a=typeof t.members_count=="number"?t.members_count:"-";q.textContent=String(a),H.textContent=`角色: ${Q(t.role)}`,K.textContent=`模式: ${V(t.endpoint)}`,D.textContent=X(t.last_error),_.textContent=t.last_sync_time||"-",ee(t.room_events);const T=t.role,u=T==="host"||T==="follower";if(b.hidden=u,w.hidden=!u,E.disabled=u,g.disabled=u,u||(s&&(window.clearTimeout(s),s=void 0),i.textContent=P,i.classList.remove("copied"),i.disabled=!1,F(),_.textContent="-"),t.endpoint){const C=t.endpoint;document.querySelectorAll("input[name='endpoint']").forEach(j=>{j.checked=j.value===C})}typeof t.follow_url=="boolean"&&(L.checked=t.follow_url)});R(v);chrome.storage.local.get({client_port:v},e=>{const t=U(String(e.client_port));R(t??v)});b.hidden=!1;w.hidden=!0;E.disabled=!1;g.disabled=!1;N();d("refresh_state");
