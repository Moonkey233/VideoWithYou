(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))l(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&l(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function l(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const m=document.getElementById("status"),x=document.getElementById("roomLabelPrefix"),_=document.getElementById("roomCode"),F=document.getElementById("membersCount"),U=document.getElementById("error"),y=document.getElementById("roomEvents"),b=document.getElementById("lastSync"),D=document.getElementById("roleBadge"),K=document.getElementById("endpointBadge"),W=document.getElementById("joinCode"),E=document.getElementById("displayName"),w=document.getElementById("preRoom"),L=document.getElementById("inRoom"),i=document.getElementById("copyBtn"),I=document.getElementById("followUrl"),k=document.getElementById("clientPort"),z=document.getElementById("applyPortBtn"),g=document.getElementById("createBtn"),h=document.getElementById("joinBtn"),G=document.getElementById("leaveBtn");let f=!1,v=null,P="",s;const S=i.textContent||"复制房间号",C=27111;let p=C;const c=[],N=6,J=["进入了房间","离开了房间"];function Q(){window.requestAnimationFrame(()=>{y.scrollTop=y.scrollHeight})}function T(){if(!f){m.textContent="本地客户端未连接";return}if(v===!0){m.textContent="本地客户端已连接, 服务器已连接";return}if(v===!1){m.textContent="本地客户端已连接, 服务器未连接";return}m.textContent="本地客户端已连接"}function V(e){switch(e){case"host":return"房主";case"follower":return"成员";default:return"-"}}function X(e){switch(e){case"browser":return"在线浏览器";case"potplayer":return"本地播放器";default:return"-"}}function Y(e){if(typeof e!="string")return"";const t=e.trim();if(!t)return"";const n=t.toLowerCase();return n==="already in a room"?"已经在房间中":n==="room action pending"?"房间操作处理中":n==="nickname required"?"请先填写昵称":n==="room not found"?"房间不存在":n==="room closed (host left)"?"房间已解散 (房主离开)":n.includes("room closed")?"房间已解散":t}function d(e,t={}){chrome.runtime.sendMessage({type:"ui_action",payload:{action:e,...t}})}function A(){y.innerHTML="";for(const e of c){const t=document.createElement("div"),n=Z(e);if(n&&n.name){const l=document.createElement("span");l.className="event-name",l.textContent=n.name;const o=document.createElement("span");o.className="event-action",o.textContent=` ${n.action}`,t.append(l,o)}else t.textContent=e;y.appendChild(t)}Q()}function Z(e){const t=e.trim();if(!t)return null;for(const n of J)if(t.endsWith(n))return{name:t.slice(0,t.length-n.length).trim(),action:n};return null}function ee(e){e&&(c.push(e),c.length>N&&c.shift(),A())}function $(){c.length=0,A()}function te(e){if(Array.isArray(e)){c.length=0;for(const t of e)typeof t=="string"&&c.push(t);c.length>N&&c.splice(0,c.length-N),A()}}function H(e){const t=Number.parseInt(e,10);return!Number.isFinite(t)||t<1||t>65535?null:t}function O(e){p=e,k.value=String(e)}g.addEventListener("click",()=>{const e=E.value.trim();d("create_room",{display_name:e})});h.addEventListener("click",()=>{const e=W.value.trim(),t=E.value.trim();e&&d("join_room",{room_code:e,display_name:t})});G.addEventListener("click",()=>d("leave_room"));i.addEventListener("click",()=>{P&&(navigator.clipboard.writeText(P).catch(()=>{}),i.textContent="已复制",i.classList.add("copied"),i.disabled=!0,s&&window.clearTimeout(s),s=window.setTimeout(()=>{i.textContent=S,i.classList.remove("copied"),i.disabled=!1},3e3))});for(const e of document.querySelectorAll("input[name='endpoint']"))e.addEventListener("change",()=>{e.checked&&d("set_endpoint",{endpoint:e.value})});I.addEventListener("change",()=>{d("set_follow_url",{follow_url:I.checked})});z.addEventListener("click",()=>{const e=H(k.value.trim());if(e===null){O(p);return}e!==p&&(p=e,chrome.runtime.sendMessage({type:"set_client_port",payload:{port:e}}))});k.addEventListener("keydown",e=>{e.key==="Enter"&&z.click()});chrome.runtime.onMessage.addListener(e=>{var M,j;if(!e||!e.type)return;if(e.type==="client_status"){f=!!((M=e.payload)!=null&&M.connected),f||(v=null,w.hidden=!1,L.hidden=!0,g.disabled=!1,h.disabled=!1,s&&(window.clearTimeout(s),s=void 0),i.textContent=S,i.classList.remove("copied"),i.disabled=!1,$(),b.textContent="-",x.textContent="房间号: ",_.textContent="-",F.textContent="-"),T();return}if(e.type==="room_event"){ee(String(((j=e.payload)==null?void 0:j.message)||""));return}if(e.type!=="ui_state")return;const t=e.payload||{};f=!0,v=typeof t.server_connected=="boolean"?t.server_connected:null,T();const n=t.room_code||"";P=n;const l=t.display_name||"",o=t.host_display_name||"";!E.value&&l&&(E.value=l);const r=o||l;if(n){const B=r?`${r}的房间号: `:"房间号: ";x.textContent=B,_.textContent=n}else x.textContent="房间号: ",_.textContent="-";const a=typeof t.members_count=="number"?t.members_count:"-";F.textContent=String(a),D.textContent=`角色: ${V(t.role)}`,K.textContent=`模式: ${X(t.endpoint)}`,U.textContent=Y(t.last_error),b.textContent=t.last_sync_time||"-",te(t.room_events);const R=t.role,u=R==="host"||R==="follower";if(w.hidden=u,L.hidden=!u,g.disabled=u,h.disabled=u,u||(s&&(window.clearTimeout(s),s=void 0),i.textContent=S,i.classList.remove("copied"),i.disabled=!1,$(),b.textContent="-"),t.endpoint){const B=t.endpoint;document.querySelectorAll("input[name='endpoint']").forEach(q=>{q.checked=q.value===B})}typeof t.follow_url=="boolean"&&(I.checked=t.follow_url)});O(C);chrome.storage.local.get({client_port:C},e=>{const t=H(String(e.client_port));O(t??C)});w.hidden=!1;L.hidden=!0;g.disabled=!1;h.disabled=!1;T();d("refresh_state");
